<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Business - Hotel Booking</title>
    <script src="https://payment-wrapper.liteapi.travel/dist/liteAPIPayment.js?v=a1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .search-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .search-type {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .search-type button {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-type button.active {
            background: #667eea;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button.primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }

        button.primary:hover {
            background: #5568d3;
        }

        button.primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .hotels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .hotel-card {
            border: 2px solid #eee;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .hotel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .hotel-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .hotel-info {
            padding: 15px;
        }

        .hotel-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .hotel-address {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .hotel-price {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
        }

        .hotel-rating {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #efe;
            border: 2px solid #cfc;
            color: #3c3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .room-offers {
            margin-top: 20px;
        }

        .room-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .room-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .offer-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .offer-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .offer-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .guest-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        #payment-form {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .sandbox-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .lp-submit-button {
            background: #667eea !important;
            color: white !important;
            border: none !important;
            padding: 15px 30px !important;
            border-radius: 5px !important;
            font-size: 18px !important;
            cursor: pointer !important;
            width: 100% !important;
            margin-top: 20px !important;
        }

        .lp-submit-button:hover {
            background: #5568d3 !important;
        }

        .booking-confirmation {
            text-align: center;
            padding: 40px;
        }

        .booking-confirmation h2 {
            color: #28a745;
            margin-bottom: 20px;
        }

        .confirmation-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }

        .back-button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .back-button:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fetch Business - Hotel Booking</h1>
        <p class="subtitle">Book hotels for your business clients</p>

        <div id="sandbox-notice" class="sandbox-notice hidden">
            <strong>Sandbox Mode:</strong> Use test card 4242 4242 4242 4242, any CVV, and any future expiration date.
        </div>

        <div id="error-message" class="error hidden"></div>
        <div id="success-message" class="success hidden"></div>

        <!-- Search Section -->
        <div id="search-section" class="search-section">
            <div class="search-type">
                <button id="place-search-btn" class="active" onclick="switchSearchType('place')">Search by Destination</button>
                <button id="vibe-search-btn" onclick="switchSearchType('vibe')">Search by Vibe</button>
            </div>

            <!-- Place Search Form -->
            <div id="place-search-form">
                <div class="form-group">
                    <label for="destination">Destination</label>
                    <input type="text" id="destination" placeholder="e.g., London, Paris, New York">
                    <input type="hidden" id="place-id">
                </div>
            </div>

            <!-- Vibe Search Form -->
            <div id="vibe-search-form" class="hidden">
                <div class="form-group">
                    <label for="vibe-query">Describe your ideal hotel</label>
                    <textarea id="vibe-query" rows="3" placeholder="e.g., romantic getaway in paris with spa"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label for="checkin">Check-in Date</label>
                <input type="date" id="checkin" required>
            </div>

            <div class="form-group">
                <label for="checkout">Check-out Date</label>
                <input type="date" id="checkout" required>
            </div>

            <div class="form-group">
                <label for="guests">Number of Guests</label>
                <input type="number" id="guests" value="2" min="1" max="10" required>
            </div>

            <button class="primary" onclick="searchHotels()">Search Hotels</button>
        </div>

        <!-- Hotels Grid -->
        <div id="loading" class="loading hidden">Searching for hotels...</div>
        <div id="hotels-grid" class="hotels-grid"></div>

        <!-- Hotel Detail Section -->
        <div id="hotel-detail" class="hidden">
            <button class="back-button" onclick="backToSearch()">← Back to Search</button>
            <div id="hotel-detail-content"></div>
        </div>

        <!-- Guest Form -->
        <div id="guest-form" class="guest-form hidden">
            <h2>Guest Information</h2>
            <div class="form-group">
                <label for="guest-first-name">First Name</label>
                <input type="text" id="guest-first-name" required>
            </div>
            <div class="form-group">
                <label for="guest-last-name">Last Name</label>
                <input type="text" id="guest-last-name" required>
            </div>
            <div class="form-group">
                <label for="guest-email">Email</label>
                <input type="email" id="guest-email" required>
            </div>
            <button class="primary" onclick="proceedToPayment()">Proceed to Payment</button>
        </div>

        <!-- Payment Form -->
        <div id="payment-section" class="hidden">
            <h2>Payment</h2>
            <div id="payment-form">
                <div id="targetElement"></div>
            </div>
        </div>

        <!-- Booking Confirmation -->
        <div id="booking-confirmation" class="booking-confirmation hidden">
            <h2>Booking Confirmed!</h2>
            <div id="confirmation-details" class="confirmation-details"></div>
            <button class="back-button" onclick="location.reload()">Book Another Hotel</button>
        </div>
    </div>

    <script>
        let config = { isSandbox: false, publicKey: 'live' };
        let searchType = 'place';
        let selectedOffer = null;
        let prebookData = null;
        let currentHotels = [];
        let currentHotelRates = [];

        // Initialize
        async function init() {
            // Load config
            const resp = await fetch('/api/config');
            config = await resp.json();

            if (config.isSandbox) {
                document.getElementById('sandbox-notice').classList.remove('hidden');
            }

            // Set default dates (tomorrow to day after tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dayAfter = new Date();
            dayAfter.setDate(dayAfter.getDate() + 2);

            document.getElementById('checkin').valueAsDate = tomorrow;
            document.getElementById('checkout').valueAsDate = dayAfter;

            // Check if returning from payment
            const urlParams = new URLSearchParams(window.location.search);
            const prebookId = urlParams.get('prebookId');
            const transactionId = urlParams.get('transactionId');

            if (prebookId && transactionId) {
                await completeBooking(prebookId, transactionId);
            }
        }

        function switchSearchType(type) {
            searchType = type;

            if (type === 'place') {
                document.getElementById('place-search-btn').classList.add('active');
                document.getElementById('vibe-search-btn').classList.remove('active');
                document.getElementById('place-search-form').classList.remove('hidden');
                document.getElementById('vibe-search-form').classList.add('hidden');
            } else {
                document.getElementById('vibe-search-btn').classList.add('active');
                document.getElementById('place-search-btn').classList.remove('active');
                document.getElementById('vibe-search-form').classList.remove('hidden');
                document.getElementById('place-search-form').classList.add('hidden');
            }
        }

        async function searchHotels() {
            const checkin = document.getElementById('checkin').value;
            const checkout = document.getElementById('checkout').value;
            const guests = parseInt(document.getElementById('guests').value);

            if (!checkin || !checkout) {
                showError('Please select check-in and check-out dates');
                return;
            }

            const requestBody = {
                occupancies: [{ adults: guests }],
                currency: 'USD',
                guestNationality: 'US',
                checkin: checkin,
                checkout: checkout,
                roomMapping: true,
                maxRatesPerHotel: 1,
                includeHotelData: true
            };

            if (searchType === 'place') {
                const destination = document.getElementById('destination').value;
                if (!destination) {
                    showError('Please enter a destination');
                    return;
                }

                // For simplicity, we'll use the destination text directly
                // In production, you'd want to implement autocomplete with place search
                try {
                    const placesResp = await fetch(`/api/places?query=${encodeURIComponent(destination)}`);
                    const placesData = await placesResp.json();

                    if (placesData.data && placesData.data.length > 0) {
                        requestBody.placeId = placesData.data[0].placeId;
                    } else {
                        showError('No places found for that destination');
                        return;
                    }
                } catch (error) {
                    showError('Error searching for destination: ' + error.message);
                    return;
                }
            } else {
                const vibeQuery = document.getElementById('vibe-query').value;
                if (!vibeQuery) {
                    showError('Please describe your ideal hotel');
                    return;
                }
                requestBody.aiSearch = vibeQuery;
            }

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) {
                    showError(data.error.message || 'Error searching hotels');
                    return;
                }

                currentHotelRates = data.data || [];
                currentHotels = data.hotels || [];

                displayHotels(currentHotelRates, currentHotels);
            } catch (error) {
                showError('Error searching hotels: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayHotels(rates, hotels) {
            const grid = document.getElementById('hotels-grid');
            grid.innerHTML = '';

            if (rates.length === 0) {
                grid.innerHTML = '<p>No hotels found. Please try different search criteria.</p>';
                return;
            }

            rates.forEach(rateData => {
                const hotelInfo = hotels.find(h => h.id === rateData.hotelId) || {};
                const firstRate = rateData.roomTypes?.[0]?.rates?.[0];

                if (!firstRate) return;

                const card = document.createElement('div');
                card.className = 'hotel-card';
                card.onclick = () => showHotelDetail(rateData.hotelId);

                const price = firstRate.retailRate?.total?.[0]?.amount || 0;
                const currency = firstRate.retailRate?.total?.[0]?.currency || 'USD';

                card.innerHTML = `
                    ${hotelInfo.main_photo ? `<img src="${hotelInfo.main_photo}" alt="${hotelInfo.name}" class="hotel-image">` : ''}
                    <div class="hotel-info">
                        <div class="hotel-name">${hotelInfo.name || 'Hotel'}</div>
                        <div class="hotel-address">${hotelInfo.address || ''}</div>
                        <div class="hotel-price">${currency} ${price.toFixed(2)}</div>
                        ${hotelInfo.rating ? `<span class="hotel-rating">★ ${hotelInfo.rating}</span>` : ''}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        async function showHotelDetail(hotelId) {
            showLoading(true);

            try {
                // Get full hotel details and all rates
                const [hotelResp, ratesResp] = await Promise.all([
                    fetch(`/api/hotel?hotelId=${hotelId}`),
                    fetch('/api/rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            hotelIds: [hotelId],
                            occupancies: [{ adults: parseInt(document.getElementById('guests').value) }],
                            currency: 'USD',
                            guestNationality: 'US',
                            checkin: document.getElementById('checkin').value,
                            checkout: document.getElementById('checkout').value,
                            roomMapping: true,
                            includeHotelData: true
                        })
                    })
                ]);

                const hotelData = await hotelResp.json();
                const ratesData = await ratesResp.json();

                document.getElementById('search-section').classList.add('hidden');
                document.getElementById('hotels-grid').classList.add('hidden');
                document.getElementById('hotel-detail').classList.remove('hidden');

                displayHotelDetail(hotelData.data, ratesData.data?.[0]);
            } catch (error) {
                showError('Error loading hotel details: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayHotelDetail(hotel, ratesData) {
            const content = document.getElementById('hotel-detail-content');

            // Group rates by room
            const roomGroups = {};
            ratesData.roomTypes?.forEach(roomType => {
                roomType.rates?.forEach(rate => {
                    const roomId = rate.mappedRoomId || 'unknown';
                    if (!roomGroups[roomId]) {
                        roomGroups[roomId] = {
                            name: rate.name,
                            offers: []
                        };
                    }
                    roomGroups[roomId].offers.push({
                        offerId: roomType.offerId,
                        ...rate
                    });
                });
            });

            let offersHtml = '<div class="room-offers">';
            Object.entries(roomGroups).forEach(([roomId, room]) => {
                offersHtml += `
                    <div class="room-group">
                        <div class="room-name">${room.name}</div>
                `;

                room.offers.forEach(offer => {
                    const price = offer.retailRate?.total?.[0]?.amount || 0;
                    const currency = offer.retailRate?.total?.[0]?.currency || 'USD';
                    const refundable = offer.cancellationPolicies?.refundableTag === 'RFN';

                    offersHtml += `
                        <div class="offer-card" onclick="selectOffer('${offer.offerId}', this)">
                            <strong>${offer.boardName}</strong><br>
                            <span style="color: #667eea; font-size: 20px; font-weight: bold;">${currency} ${price.toFixed(2)}</span><br>
                            <span style="color: ${refundable ? 'green' : 'red'};">${refundable ? 'Refundable' : 'Non-Refundable'}</span>
                        </div>
                    `;
                });

                offersHtml += '</div>';
            });
            offersHtml += '</div>';

            content.innerHTML = `
                <h2>${hotel.name}</h2>
                <p>${hotel.address}</p>
                ${hotel.hotelDescription || ''}
                ${offersHtml}
                <button class="primary" onclick="showGuestForm()" style="margin-top: 20px;">Continue to Booking</button>
            `;
        }

        function selectOffer(offerId, element) {
            document.querySelectorAll('.offer-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedOffer = offerId;
        }

        function showGuestForm() {
            if (!selectedOffer) {
                showError('Please select a room offer');
                return;
            }

            document.getElementById('hotel-detail').classList.add('hidden');
            document.getElementById('guest-form').classList.remove('hidden');
        }

        async function proceedToPayment() {
            const firstName = document.getElementById('guest-first-name').value;
            const lastName = document.getElementById('guest-last-name').value;
            const email = document.getElementById('guest-email').value;

            if (!firstName || !lastName || !email) {
                showError('Please fill in all guest information');
                return;
            }

            // Store guest info for later
            window.guestInfo = { firstName, lastName, email };

            showLoading(true);

            try {
                const response = await fetch('/api/prebook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        offerId: selectedOffer,
                        usePaymentSdk: true
                    })
                });

                const data = await response.json();

                if (data.error) {
                    showError(data.error.message || 'Error prebooking');
                    return;
                }

                prebookData = data.data;

                // Store prebookId and transactionId in sessionStorage
                sessionStorage.setItem('prebookId', prebookData.prebookId);
                sessionStorage.setItem('transactionId', prebookData.transactionId);
                sessionStorage.setItem('guestInfo', JSON.stringify(window.guestInfo));

                document.getElementById('guest-form').classList.add('hidden');
                document.getElementById('payment-section').classList.remove('hidden');

                initializePayment();
            } catch (error) {
                showError('Error prebooking: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function initializePayment() {
            const returnUrl = `${window.location.origin}/?prebookId=${prebookData.prebookId}&transactionId=${prebookData.transactionId}`;

            const liteAPIConfig = {
                publicKey: config.publicKey,
                secretKey: prebookData.secretKey,
                returnUrl: returnUrl,
                targetElement: '#targetElement',
                appearance: { theme: 'flat' },
                options: { business: { name: 'Fetch Business' } }
            };

            const liteAPIPayment = new LiteAPIPayment(liteAPIConfig);
            liteAPIPayment.handlePayment();
        }

        async function completeBooking(prebookId, transactionId) {
            showLoading(true);

            // Retrieve guest info from sessionStorage
            const guestInfoStr = sessionStorage.getItem('guestInfo');
            if (!guestInfoStr) {
                showError('Guest information not found. Please try again.');
                return;
            }

            const guestInfo = JSON.parse(guestInfoStr);

            try {
                const response = await fetch('/api/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prebookId: prebookId,
                        holder: {
                            firstName: guestInfo.firstName,
                            lastName: guestInfo.lastName,
                            email: guestInfo.email
                        },
                        payment: {
                            method: 'TRANSACTION_ID',
                            transactionId: transactionId
                        },
                        guests: [{
                            occupancyNumber: 1,
                            firstName: guestInfo.firstName,
                            lastName: guestInfo.lastName,
                            email: guestInfo.email
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    showError(data.error.message || 'Error completing booking');
                    return;
                }

                // Clear session storage
                sessionStorage.clear();

                // Show confirmation
                displayBookingConfirmation(data.data);
            } catch (error) {
                showError('Error completing booking: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayBookingConfirmation(booking) {
            document.getElementById('search-section').classList.add('hidden');
            document.getElementById('hotels-grid').classList.add('hidden');
            document.getElementById('hotel-detail').classList.add('hidden');
            document.getElementById('guest-form').classList.add('hidden');
            document.getElementById('payment-section').classList.add('hidden');
            document.getElementById('booking-confirmation').classList.remove('hidden');

            const details = document.getElementById('confirmation-details');
            details.innerHTML = `
                <h3>Booking Details</h3>
                <p><strong>Booking ID:</strong> ${booking.bookingId}</p>
                <p><strong>Hotel Confirmation Code:</strong> ${booking.hotelConfirmationCode}</p>
                <p><strong>Hotel:</strong> ${booking.hotel?.name}</p>
                <p><strong>Check-in:</strong> ${booking.checkin}</p>
                <p><strong>Check-out:</strong> ${booking.checkout}</p>
                <p><strong>Total Price:</strong> ${booking.currency} ${booking.price}</p>
                <p><strong>Status:</strong> ${booking.status}</p>
            `;
        }

        function backToSearch() {
            document.getElementById('hotel-detail').classList.add('hidden');
            document.getElementById('search-section').classList.remove('hidden');
            document.getElementById('hotels-grid').classList.remove('hidden');
            selectedOffer = null;
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
